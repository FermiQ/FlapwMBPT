      module vertex_mod
      character*3 :: theta_bse,
     &               vrt_x_appr
      character*4 :: bse_kernel_p
      character*5 :: psi_p,
     &               psi_sig,
     &               psi2_sig
      logical :: fi_dot_incl,
     &           p_reducible,
     &           scale_psi,
     &           w_red_print
      integer :: ind_chi(4),
     & 	         ind_ixc(4),
     &	         iter_ladder_p,
     & 	         iter_ladder_xi,
     &           iter_sigma_gwg,
     &	         k_irrep_max,
     &	         k_star_max_c,
     &	         lagr_nu2,
     &	         lagr_om1,
     &	         limlb_red,
     &	         max_e_pb_red,
     &	         maxb_red,
     &	         maxel_red,
     &	         maxlfpb_red,
     &	         maxlfun_red,
     &	         maxntle_loc,
     &	         maxpb_red,
     &	         maxpbr_red,
     &           mode_bts,
     &	         n_block_k_max,
     &	         n_chi_0,
     &	         n_ixc_0,
     &	         n_lem2_red,
     &	         n_nu_adapt_max,
     &	         n_nu_b_max,
     &	         n_nu1_max,
     &	         n_nu2_max,
     &	         n_om1_max,
     &	         n_omega1_max,
     &	         n_omega2_max,
     &	         n_omega_b_max,
     &	         n_omega2_b_max,
     &           n_opt_pb_red,
     &	         n_pbmt_red,
     &	         n_pbmtm_red,
     &	         n_pbtot_red,
     &	         n_step_v,
     &	         nbasmpw_red,
     &	         nc_line,
     &	         ndiv_c(3),
     &	         nfun_red,
     &	         nindm_fif,
     &	         nn_per,
     &	         np_rs_red,
     &	         npb_g2_w2_full,
     &	         npb_g2_w2_max,
     &	         npb_g2_w4_full,
     &	         npb_rs_red,
     &	         npb_u_full,
     &	         npb_u_max,
     &	         npb_wan_4_max,
     &	         nplw_gw_red,
     &	         npnt_c,
     &	         nqdiv_c,
     &	         nr_full_red,
     &	         nr_red_red,
     &	         nra_red,
     &	         nrax_chi,
     &	         nrdiv_red(3),
     &           nrr_max_c,
     &	         nrs_red,
     &	         nu_adapt_om_all,
     &	         nu_ext,
     &	         nu_om_om1_max,
     &	         nu_om_om2_max,
     &	         nu_w_stat,
     &	         num_baryc_ac_max,
     &	         num_kk_k,
     &	         num_kk_k_ac,
     &	         num_rr_coarse_sph,
     &	         omega_nu_nu1_max,
     &	         omega_nu_nu2_max,
     &	         omnu_adapt_om_all
      real*8 :: cut_bnd_red,
     &          cut_pw_red,
     &	        eps_pb_vrt,
     &          freq_chi,
     &          h_tau_x,
     &          p_uni_exact,
     &          q0b0_red(3,3),
     &          qb0_c(3,3),
     &          r0b0_red(3,3),
     &          rb0_c(3,3),
     &          x_tau_max
      integer, allocatable :: a_index(:,:),
     &	                      g_sym_0_c(:,:),
     &	                      i_kref_c(:),
     &                        ig_pair_c(:,:,:),
     &	                      ij_transp(:),
     &	                      ind_kk_k_ac(:,:),
     &	                      ind_fif(:,:,:,:),
     &	                      ind_fun0_loc(:,:,:),
     &	                      ind_nu_d_c(:),
     &	                      ind_nu_int_c(:),
     &	                      ind_nu2_int(:,:),
     &	                      ind_om1_int(:,:),
     &	                      ind_omega_b_d(:,:),
     &	                      ind_omega_int_b(:,:),
     &	                      ind_pb_red(:,:),
     &	                      ind_prod_red(:,:,:),
     &	                      ind_prod0_red(:,:,:),
     &	                      ind_xi_all(:),
     &	                      indbasa_red(:,:,:,:),
     &	                      index_k1_c(:),
     &	                      indfun0_loc(:,:,:),
     &	                      indgb_red(:,:),
     &	                      indpw_gw_red(:,:),
     &	                      io_lem_red(:),
     &	                      io_lem2_red(:),
     &	                      iopb_red(:),
     &	                      iopb0_red(:),
     &	                      ip_k_c(:,:),
     &	                      ip_r_red(:,:),
     &	                      iplf_bk_red(:,:),
     &	                      iplf_gk_red(:,:),
     &	                      ir_group_red(:),
     &	                      ir_ref_red(:),
     &	                      k_c_from_a(:),
     &	                      k_a_from_c(:),
     &	                      k_group_c(:),
     &	                      k_list_c(:,:),
     &	                      k_npnt_in_line_c(:),
     &	                      k_star_c(:),
     &	                      k_sym_0_c(:,:),
     &	                      kline_in_npnt_c(:),
     &	                      le_red(:,:),
     &	                      lf_isz_red(:,:),
     &	                      lf_pb_red(:,:),
     &	                      lfun_pb_red(:),
     &	                      lfun_red(:),
     &	                      lfunm_red(:),
     &	                      lim_pb_mt_red(:,:),
     &	                      list_sym_p(:,:),
     &	                      list_sym_sigma(:,:),
     &	                      lm_pbmt_red(:,:),
     &	                      lmb_red(:),
     &	                      lme_red(:,:),
     &	                      lmpb_red(:),
     &	                      lval_pb_red(:,:),
     &	                      mat_nu_adapt(:),
     &	                      mat_omnu_adapt(:),
     &	                      n_as_nu_omega(:,:),
     &	                      n_as_omega_nu(:,:),
     &	                      n_ex_nu_omega(:,:),
     &	                      n_ex_omega_nu(:),
     &	                      n_pbmt0_red(:),
     &	                      n_sym_p(:),
     &	                      n_sym_sigma(:),
     &	                      n_wan(:,:),
     &	                      nbask_red(:),
     &	                      nind_fif(:,:,:),
     &	                      npb_g2_w2(:),
     &	                      npb_u(:),
     &	                      npb_wan_4(:),
     &	                      nplwgw_red(:),
     &                        nrr_red_c(:,:),
     &	                      ntle_loc(:,:),
     &	                      ntle_pb_red(:,:),
     &	                      nu_adapt(:,:,:),
     &	                      nu_adapt_index_zero(:),
     &	                      nu_adapt_om_ind(:,:),
     &	                      nu2_adapt(:,:),
     &	                      num_adapt(:,:),
     &	                      num_baryc_ac(:),
     &	                      num_nu_bar(:),
     &	                      num_nu1_adapt(:),
     &	                      num_nu2_adapt(:),
     &	                      num_nu2_adapt_d(:),
     &	                      num_nu_om_om1(:,:,:),
     &	                      num_nu_om_om2(:,:),
     &	                      num_nu_omega(:),
     &	                      num_om1_adapt(:),
     &	                      num_om1_adapt_d(:),
     &	                      num_omega1_adapt(:),
     &	                      num_omega1_omega(:),
     &	                      num_omega2_adapt(:),
     &	                      num_omega_bar(:),
     &	                      num_omega_nu_nu1(:,:,:),
     &	                      num_omega_nu_nu2(:,:),
     &	                      num_omega2_bar(:),
     &	                      omega1_adapt(:,:),
     &	                      omega2_adapt(:,:),
     &	                      omega2_bar(:,:),
     &	                      omnu_adapt_om_ind(:,:),
     &	                      r_pnt_red(:,:),
     &	                      r_pnt_ind_red(:),
     &                        r0_pair_c(:,:,:),
     &	                      site_index(:,:,:),
     &	                      weight_triple_cor(:)
      real*8, allocatable :: atm_orb_rad(:,:,:,:,:),
     &	                     atm_orb_rad_smooth(:,:,:,:,:),
     &	                     coef_baryc_ac(:,:),
     &	                     dfun_pb_red(:),
     &                       dif_kk_k_ac(:,:),
     &	                     fi_h_fi(:,:,:,:),
     &	                     fi_j_fi(:,:,:,:),
     &	                     fi0_f_red(:,:,:,:,:,:),
     &	                     fi0_red(:,:,:,:,:,:),
     &	                     fif0(:,:,:,:,:,:),
     &	                     fun_pb_red(:),
     &                       fxc_00_bts(:),
     &                       fxc_bts(:,:),
     &	                     g_0_wan_tau(:,:,:,:,:,:),
     &	                     g_1_wan_tau(:,:,:,:,:,:),
     &	                     g_10_wan_tau(:,:,:,:,:,:),
     &	                     g_2_wan_tau(:,:,:,:,:,:),
     &	                     g_0_wan_omega(:,:,:,:,:,:),
     &	                     g_1_wan_omega(:,:,:,:,:,:),
     &	                     g_10_wan_omega(:,:,:,:,:,:),
     &	                     g_2_wan_omega(:,:,:,:,:,:),
     &	                     g_loc_t_t1_rr(:,:,:,:,:,:),
     &	                     g_shell_tau(:,:,:,:,:,:,:),
     &                       nu_nu_from_tau_nu(:,:,:,:,:),
     &                       nu_om_from_tau_om(:,:,:,:,:),
     &	                     omega_from_omega(:,:),
     &                       omega_nu_from_tau_nu(:,:,:,:),
     &                       omega_nu_from_tau_nu_ab(:,:,:,:),
     &                       omega_om_from_tau_om(:,:,:,:,:),
     &                       p_gw_nu(:,:,:,:),
     &                       p_gw_nu_q(:,:,:,:),
     &                       p_gw_tau(:,:,:,:),
     &                       p_gw_tau_q(:,:,:,:),
     &                       p_head_vrt(:,:),
     &                       p_homo_vertex_nu(:,:),
     &                       p_loc_vertex_nu(:,:,:,:),
     &                       p_loc_vertex_tau(:,:,:,:),
     &                       p_sc_nu_q(:,:,:,:),
     &                       p_sc_nu_q_old(:,:,:,:),
     &                       p_sc_tau_q(:,:,:,:),
     &                       p_vertex_nu_q(:,:,:,:),
     &                       p_vertex_nu_q_old(:,:,:,:),
     &                       p_vertex_nu_q1(:,:,:,:),
     &                       p_vertex_tau_q1(:,:,:,:),
     &                       p_vrt_nu_q(:,:,:,:),
     &                       p_wan_nu_q(:,:,:,:),
     &                       p_wan_tau_q(:,:,:,:),
     &                       pnt_baryc_ac(:,:,:),
     &                       pnt_c(:,:),
     &                       ratio_vxc_sigx(:,:,:),
     &                       resp_lda_tau_ii(:,:,:,:),
     &                       resp_lda_tau_mi(:,:,:,:,:),
     &                       resp_lda_tau_mm(:,:,:,:),
     &                       rpb_fpb(:,:,:,:),
     &                       rr_c3(:,:),
     &	                     rr_coarse(:,:),
     &                       sig_bnd_vertex(:,:,:,:,:,:),
     &                       sig_gw_tau(:,:,:,:,:,:),
     &                       sig_sc_tau_k(:,:,:,:,:,:),
     &                       sig_sc_tau_k_old(:,:,:,:,:,:),
     &                       sig_sc_x_k(:,:,:,:),
     &                       sig_sc_x_k_old(:,:,:,:),
     &                       sig_vertex_omega_k(:,:,:,:,:,:),
     &                       sig_vertex_tau(:,:,:,:,:,:),
     &                       sig_vertex_tau_k(:,:,:,:,:,:),
     &                       sigma_vertex_tau(:,:,:,:,:,:),
     &	                     sum_nu_adapt_vertex(:,:,:),
     &	                     sum_nu_asy_c(:,:,:),
     &	                     sum_nu_asy_cc(:,:,:),
     &	                     sum_omega_vertex(:),
     &	                     sum_omega1_spl(:,:,:),
     &                       tau_x_change(:),
     &                       tau2_integral(:,:,:),
     &                       thet_me(:,:,:,:),
     &                       theta_mt(:,:),
     &	                     tshift_r_red(:,:,:),
     &                       v_opt_e_red(:),
     &                       v_sc_h_k(:,:,:,:),
     &                       v_sc_h_k_old(:,:,:,:),
     &	                     v_store_2(:,:,:,:,:),
     &                       vert_vert_m(:,:,:,:,:),
     &                       vpb_fpb(:,:,:,:),
     &	                     w_nu_adapt_nu(:,:),
     &	                     w_nu_adapt_om(:,:),
     &	                     w_nu_adapt_omega(:,:),
     &	                     w_nu_om_om1(:,:,:,:),
     &	                     w_nu_om_om2(:,:,:),
     &	                     w_om_adapt_nu(:,:),
     &	                     w_om_adapt_om(:,:),
     &	                     w_om_adapt_omega(:,:),
     &	                     w_omega_nu_nu1(:,:,:,:),
     &	                     w_omega_nu_nu2(:,:,:),
     &	                     w_nu_q_b(:,:,:,:),
     &	                     w_store_2(:,:,:,:,:,:),
     &	                     wan_norm(:,:),
     &	                     wgt_c(:),
     &	                     wgt_nu_om_om1(:,:,:,:),
     &	                     wgt_nu_om_om2(:,:,:),
     &	                     wgt_omega_nu_nu1(:,:,:,:),
     &	                     wgt_omega_nu_nu2(:,:,:),
     &	                     wgt_omega_om(:,:),
     &	                     wgt_omega_omt(:,:),
     &                       x_coef(:,:,:,:),
     &                       x_mesh_cubic(:),
     &                       xi_l_homo_vertex_nu(:,:)
      complex*16, allocatable :: a_bnd_red(:,:,:,:),
     &                           bb_red(:,:),
     &	                         bbm_low(:,:,:,:,:,:),
     &	                         bbm_store(:,:,:,:,:,:),
     &                           bk_bz_red(:),
     &                           bm_coef_red(:,:),
     &                           ckq_bz(:,:),
     &                           eps_vertex_nu(:,:),
     &	                         g_loc_t_t1_rr_omega(:,:,:,:,:),
     &	                         g_loc_tau_rel(:,:,:,:,:),
     &	                         g_wan_qp_asy(:,:,:,:),
     &                           gc_loc_t_t1_rr(:,:,:,:,:),
     &	                         gx_shell(:,:,:,:,:),
     &                           ima_p(:,:,:,:),
     &                           ima_sigma(:,:,:,:,:),
     &	                         l_p_overl(:,:,:,:),
     &	                         lambda_uniform(:,:,:,:,:),
     &	                         lambda_uniform_exa(:,:,:,:,:),
     &	                         m_p_overl_s(:,:,:),
     &	                         m_p_overl_wan(:,:,:),
     &	                         mtild_p_overl_s(:,:,:),
     &	                         mtild_p_overl_u(:,:,:),
     &                           p_s_p_tn(:,:,:),
     &                           ps3_vertex(:,:,:,:,:,:),
     &                           ps3_wan(:,:,:,:,:,:),
     &                           psi_psi_pw(:,:,:,:,:,:),
     &                           psps_ac(:,:,:,:,:),
     &                           pw_p_overl_s(:,:),
     &                           pw_pb_red(:,:),
     &                           pw_pb_tild_red(:,:),
     &                           rpb_fpb_int(:,:,:),
     &                           sig_c_wi(:,:,:,:,:),
     &                           sig_gw_omega(:,:,:,:,:),
     &                           sig_loc_vertex_tau_rel(:,:,:,:,:),
     &                           sigc_r(:,:,:,:,:,:),
     &                           strcon(:,:,:),
     &                           tau_from_nu_nu(:,:,:),
     &                           tau_from_nu_omega(:,:,:,:),
     &                           tau_from_nu_omega_1(:,:,:),
     &                           tau_from_omega_nu(:,:,:,:),
     &                           tau_from_omega_omega(:,:,:,:),
     &                           tau_nu_from_omega_nu(:,:,:),
     &                           tau_nu_from_nu_nu(:,:,:,:),
     &                           tau_nu_from_nu_nu_1(:,:,:),
     &                           tau_om_from_nu_om(:,:,:,:),
     &                           tau_om_from_nu_om_1(:,:,:),
     &                           tau_om_from_omega_om(:,:,:),
     &                           thet_ph_loc(:,:,:,:,:,:),
     &                           thet_pp_loc(:,:,:,:,:,:),
     &                           thet_ph_q(:,:,:,:,:,:),
     &                           thet_pp_q(:,:,:,:,:,:),
     &                           theta_int(:,:),
     &                           u_pw_u(:,:,:,:,:),
     &	                         vert_vert_m_rel(:,:,:,:),
     &	                         vertex_bnd_uniform(:,:,:,:,:),
     &	                         v_coarse(:,:,:),
     &	                         v_coarse_u(:,:,:),
     &	                         v_coarse_wan(:,:,:),
     &                           v_red_b(:,:,:),
     &	                         v_red_q(:,:,:),
     &                           vrt_scale(:,:,:,:),
     &                           vrt_wi(:,:,:,:,:),
     &	                         w_coarse(:,:,:,:),
     &	                         w_coarse_u(:,:,:,:),
     &	                         w_coarse_wan(:,:,:,:),
     &	                         w_mu(:,:,:,:),
     &	                         w_red_q(:,:,:,:),
     &                           w_vrt_q(:,:,:,:,:),
     &                           w_vrt_loc(:,:,:,:,:),
     &                           w11_red(:,:,:),
     &	                         wan_wan_pw(:,:,:,:,:),
     &	                         wan_wan_pw_2(:,:,:,:,:,:),
     &	                         wwm_fac(:,:,:,:,:),
     &                           xi_t_homo_vertex_nu(:,:),
     &	                         z_bnd_red(:,:,:,:),
     &                           z_wi(:,:,:,:),
     &	                         zz_coef(:,:,:)
      end
