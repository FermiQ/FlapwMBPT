      subroutine memory_heg
	use heg_mod
	use etot_mod
	use manager_mod
	use models_mod
	use parallel_mod
	use solid_mod
	use vertex_mod
      implicit none
      allocate(conv_ladder(nc_line,0:n_nu))
      allocate(e_star_free(0:n_k_heg,nspin))
      allocate(e_star_qp(0:n_k_heg,nspin))
      allocate(e_star_x(0:n_k_heg,nspin))
      allocate(e1_heg(0:n_q_heg,0:n_nu))
      allocate(edd_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(f_xc(0:n_q_heg,0:n_nu))
      allocate(f_xc_zz(0:n_q_heg,0:n_nu))
      allocate(g_fac_a(0:n_q_heg,0:n_nu))
      allocate(g_fac_n(0:n_q_heg,0:n_nu))
      allocate(g_fac_s(0:n_q_heg,0:n_nu))
      allocate(g_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(g_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(g_k_tau_spl(n_k_heg,4,0:n_tau,nspin))
      allocate(g_r_tau_heg(0:n_r_heg,0:n_tau,nspin))
      allocate(g_rax_heg(0:ndos,0:n_k_heg,nspin))
      allocate(g0_k_tau_heg(0:n_k_heg,0:n_tau))
      allocate(gc_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(gx_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(gc_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(gc_k_tau_spl(n_k_heg,4,0:n_tau,nspin))
      allocate(gsig_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(gsig_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(gsig_k_tau_spl(n_k_heg,4,0:n_tau,nspin))
      allocate(gx_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(p_as_nu_par(0:n_q_heg,2))
      allocate(p_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(p_q_nu_vertex_rad(0:n_q_heg,0:n_nu))
      allocate(p_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(p_q_tau_vertex_heg(0:n_q_heg,0:n_tau/2))
      allocate(p_wi_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(p0_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(p0_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(resp0_as_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(resp0_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(resp0_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(resp0_q0_coeff(0:n_q_heg,0:n_nu))
      allocate(resp_line_heg(1,0:n_nu))
      allocate(resp_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(resp_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(resp_q0_coeff(0:n_q_heg,0:n_nu))
      allocate(resp_r_tau_heg(0:n_r_heg,0:n_tau/2))
      allocate(resp_zz_line_heg(1,0:n_nu))
      allocate(sig_0_heg(0:n_k_heg,nspin))
      allocate(sig_k_omega_spl(n_k_heg,4,0:n_omega,nspin))
      allocate(sig_k_omega_vertex_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(sig_k_tau_vertex_heg(0:n_tau,nc_line,nspin))
      allocate(sig_k_tau_vertex_rad(0:n_k_heg,0:n_tau,nspin))
      allocate(sig_real_heg(0:n_k_heg,0:ndos,nspin))
      allocate(sigc_gw_k_omega_spl(n_k_heg,4,0:n_omega,nspin))
      allocate(sigc_k_omega_as(0:n_omega,nspin))
      allocate(sigc_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(sigc_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(sigc_k_tau_heg_old(0:n_k_heg,0:n_tau,nspin))
      allocate(sigc0_k_tau_heg(0:n_k_heg,0:n_tau,nspin))
      allocate(sigc_qp_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(sigc0_k_omega_heg(0:n_k_heg,0:n_omega,nspin))
      allocate(sigx_at_large_k(0:n_k_heg))
      allocate(sigx_k_heg(0:n_k_heg,nspin))
      allocate(sigx_k_heg_old(0:n_k_heg,nspin))
      allocate(sigx_k_heg_r(0:n_k_heg))
      allocate(sigx_k_spl(n_k_heg,4,nspin))
      allocate(spectrum(0:n_k_heg))
      allocate(spectrum_ac(0:n_k_heg))
      allocate(v_q_heg(0:n_q_heg))
      allocate(v_r_heg(0:n_r_heg))
      allocate(w_as_nu_par(0:n_q_heg,2))
      allocate(w_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(w_q_nu_spl(n_q_heg,4,0:n_nu))
      allocate(w_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(w_r_nu_heg(0:n_r_heg,0:n_nu))
      allocate(w_r_tau_heg(0:n_r_heg,0:n_tau/2))
      allocate(w_wi_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(w_wi_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(w0_as_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(w0_q_nu_heg(0:n_q_heg,0:n_nu))
      allocate(w0_q_tau_heg(0:n_q_heg,0:n_tau/2))
      allocate(z_ren_heg(0:n_k_heg,nspin))
      allocate(dg_k_tau_heg(0:n_k_heg,3,nspin))
      allocate(dgc_k_tau_heg(0:n_k_heg,3,nspin))
      allocate(dgx_k_tau_heg(0:n_k_heg,3,nspin))
      allocate(dg_r_tau_heg(0:n_r_heg,3,nspin))
      allocate(dg_k_tau_spl(n_k_heg,4,3,nspin))
      allocate(dp_q_tau_heg(0:n_q_heg))
      allocate(dsigc_k_tau_heg(0:n_k_heg,3,nspin))
      allocate(dw_q_tau_heg(0:n_q_heg))
      if(iter_psi+iter_bsp/=0) then
        allocate(e_star_xc(nstar_c,nspin))
        allocate(g_k_omega_heg_c(0:n_omega,nstar_c,nspin))
        allocate(dg_k_tau_heg_c(3,nstar_c,nspin))
        allocate(g_k_tau_heg_c(0:n_tau,nstar_c,nspin))
        allocate(g_r_tau_heg_c(nrr_div_c,0:n_tau,nspin))
        allocate(gx_k_omega_heg_c(0:n_omega,nstar_c,nspin))
        allocate(gx_k_tau_heg_c(0:n_tau,nstar_c,nspin))
        allocate(p_q_nu_vertex_heg(0:n_nu,nc_line))
        allocate(sigx_k_heg_c(nstar_c,nspin))
        allocate(sigc_k_omega_heg_c(0:n_omega,nstar_c,nspin))
        allocate(sigc_k_tau_heg_c(0:n_tau,nstar_c,nspin))
        allocate(v_q_heg_c(nstar_c))
        allocate(v_r_heg_c(nrr_div_c))
        allocate(w_q_nu_heg_c(0:n_nu,nstar_c))
        allocate(w_q_tau_heg_c(0:n_tau/2,nstar_c))
        allocate(w_r_tau_heg_c(nrr_div_c,0:n_tau/2))
      endif
c --------------------------------------------------------------      
	allocate(ndim3_k(nproc_k))
	allocate(n3_mpi_k(nproc_k))
	call size_shift_par(n_q_heg+1,nproc_k,ndim3_k,n3_mpi_k)
      end